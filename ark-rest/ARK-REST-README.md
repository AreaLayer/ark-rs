# Ark REST Client

A high-level Rust HTTP client for the Ark protocol, providing access to both the main Ark service and indexer APIs
through a unified interface.

## Architecture

This crate consists of two main parts:

- **Generated Code** (`src/generated/`) - Auto-generated OpenAPI client code (don't edit manually)
- **Client Wrapper** (`src/client.rs`) - High-level client providing a clean, idiomatic Rust API

The generated code is created from merged OpenAPI/Swagger specifications that combine:

- `swagger/service.swagger.json` - Main Ark service API
- `swagger/indexer.swagger.json` - Indexer service API
- `swagger/types.swagger.json` - Shared type definitions

## Prerequisites

1. **Python 3** (for merging swagger files)
2. **Node.js and npm** (for OpenAPI generator)
3. **Just** (task runner) - `cargo install just`

Install the OpenAPI Generator CLI:

```bash
npm install @openapitools/openapi-generator-cli -g
```

## Quick Start

### 1. Generate the Client

```bash
# Generate client from latest swagger specs
just regen
```

This will:

- Merge the three swagger files into one
- Generate Rust client code
- Apply necessary fixes to the generated code
- Format the code

### 2. Build and Test

```bash
# Build the project
just build

# Run tests
just test
```

### 3. Use the Client

```rust
use ark_rest::Client;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // Create a new client
    let client = Client::new("http://localhost:8080");

    // Get server info
    let info = client.get_info().await?;
    println!("Server version: {}", info.version);

    // List VTXOs
    let vtxos = client.list_vtxos(scripts, None, None).await?;
    println!("Found {} VTXOs", vtxos.vtxos.len());

    // Subscribe to script notifications
    let subscription_id = client
        .subscribe_to_scripts(scripts, "my-sub".to_string())
        .await?;
    println!("Created subscription: {}", subscription_id);

    Ok(())
}
```

## Available Commands

| Command                 | Description                                            |
| ----------------------- | ------------------------------------------------------ |
| `just`                  | Show all available commands                            |
| `just regen`            | Full regeneration: merge → generate → fix              |
| `just generate`         | Generate client from merged swagger                    |
| `just merge-swagger`    | Merge swagger files only                               |
| `just fix-generated`    | Apply fixes to generated code                          |
| `just build`            | Build the project                                      |
| `just test`             | Run tests                                              |
| `just test-wasm`        | Run WASM tests (requires Ark server on localhost:7070) |
| `just test-wasm-chrome` | Run WASM tests with Chrome instead of Firefox          |
| `just check`            | Check for compilation errors                           |
| `just fmt`              | Format code                                            |
| `just clean`            | Clean all generated files                              |
| `just dev`              | Development workflow (regen + build)                   |
| `just show-structure`   | Show generated file structure                          |

## Directory Structure

```
ark-rest/
├── ARK-REST-README.md         # This file (won't be overwritten)
├── README.md                  # Auto-generated by OpenAPI generator
├── justfile                   # Build tasks and automation
├── merge_swagger.py           # Script to merge swagger files
├── openapi-config.yaml        # OpenAPI generator configuration
├── swagger/                   # OpenAPI specifications
│   ├── service.swagger.json   # Ark service API
│   ├── indexer.swagger.json   # Indexer API
│   ├── types.swagger.json     # Shared types
│   └── merged.swagger.json    # Generated merged spec
├── src/
│   ├── generated/             # Auto-generated code (don't edit)
│   │   ├── src/
│   │   │   ├── apis/         # API implementations
│   │   │   └── models/       # Data models
│   │   └── docs/             # API documentation
│   ├── client.rs             # High-level client wrapper
│   ├── error.rs              # Error handling
│   └── lib.rs                # Library entry point
└── tests/                     # Integration tests
```

## API Coverage

The client provides access to:

### Ark Service API

- **Batch Operations**: Register intents, confirm registration, submit transactions
- **Transaction Management**: Submit, finalize, and track Ark transactions
- **Event Streaming**: Real-time batch and signing events
- **Tree Operations**: Submit nonces and signatures for multi-sig trees

### Indexer Service API

- **VTXO Management**: Query VTXOs by scripts or outpoints
- **Chain Analysis**: Get VTXO chains and tree structures
- **Transaction History**: Access virtual transactions and commitments
- **Subscriptions**: Subscribe to script notifications and real-time updates

## Configuration

The OpenAPI generator is configured via `openapi-config.yaml`:

```yaml
generatorName: rust
outputDir: ./src/generated
library: reqwest
inputSpec: swagger/merged.swagger.json
additionalProperties:
  packageName: ark-rest
  supportAsync: true
  reqwestVersion: "^0.11"
```

## Updating the Client

When the Ark APIs change:

1. **Update swagger files** - Download latest specs to `swagger/` directory
2. **Regenerate client** - Run `just regen`
3. **Review changes** - Check generated code and update client wrapper if needed
4. **Test thoroughly** - Run `just test` to ensure everything works

## WASM Testing

The client includes WebAssembly compatibility tests that can be run in a browser environment.

### Prerequisites for WASM Tests

1. **wasm-pack** - Automatically installed by the just commands if missing
2. **Running Ark server** - Tests expect server on `http://localhost:7070`
3. **Browser** - Firefox or Chrome (headless mode)

### Running WASM Tests

```bash
# Run WASM tests with Firefox (default)
just test-wasm

# Run WASM tests with Chrome
just test-wasm-chrome
```

The WASM tests verify that the client works correctly in a browser environment and can successfully communicate with the
Ark server.

## Troubleshooting

### Common Issues

1. **Generation fails**: Check that all swagger files are present and valid
2. **Compilation errors**: Run `just fix-generated` to apply known fixes
3. **Format issues**: Run `just fmt` to format the code
4. **Missing dependencies**: Ensure Node.js, Python, and Just are installed
5. **WASM tests fail**: Ensure Ark server is running on localhost:7070 and wasm-pack is installed

### Manual Fixes

If you encounter issues with the generated code:

1. **Don't edit generated files directly** - they'll be overwritten
2. **Update the fix script** - Add sed commands to `justfile`
3. **Report issues** - Consider reporting to the OpenAPI generator project

## Contributing

1. Changes to the client wrapper (`src/client.rs`, `src/error.rs`) are manual
2. Changes to generated code should be automated in the `fix-generated` task
3. Always run `just test` before committing changes
4. Update this README when adding new features

## License

This project is part of the Ark protocol implementation.
